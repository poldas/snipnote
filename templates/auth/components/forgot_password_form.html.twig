{% set action = action ?? '/forgot-password' %}
{% set csrfToken = csrfToken ?? csrf_token('forgot_password') %}
{% set errors = errors ?? [] %}
{% set prefill = prefill ?? {} %}
{% set pending = pending ?? false %}
{% set success = success ?? null %}

{% set emailError = (errors|filter(e => (e.field ?? null) == 'email')|first).message ?? null %}
{% set globalErrors = errors|filter(e => e.field is not defined or e.field is null)|map(e => e.message) %}

<form action="{{ action }}" method="post" class="space-y-4" hx-boost="false" data-turbo="false">
    <input type="hidden" name="_csrf_token" value="{{ csrfToken }}">

    {% include 'components/alert.html.twig' with { messages: globalErrors } %}

    {% if success %}
        <div class="rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-900 px-4 sm:px-6 py-4 sm:py-5 text-center" role="status">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <p class="text-sm sm:text-base font-bold mb-1">{{ success }}</p>
            <p class="text-xs sm:text-sm text-emerald-800/80">Jeśli konto istnieje, wiadomość pojawi się w skrzynce w ciągu kilku minut. Sprawdź również folder Spam.</p>
            <div class="mt-4 sm:mt-6">
                <a href="/login" class="text-sm sm:text-base text-indigo-600 hover:text-indigo-800 font-semibold underline underline-offset-4 transition-colors">Wróć do logowania</a>
            </div>
        </div>
    {% else %}
        {% include 'auth/components/form_field.html.twig' with {
            config: {
                id: 'forgot-email',
                name: 'email',
                label: 'Adres email',
                type: 'email',
                placeholder: 'your@email.com',
                autocomplete: 'email',
                required: true,
                pattern: '[^@\\s]+@[^@\\s]+\\.[^@\\s]+',
                maxLength: 180
            },
            value: prefill.email ?? '',
            error: emailError,
            autoFocus: true
        } %}

        <button type="submit"
                class="w-full inline-flex items-center justify-center rounded-2xl text-white px-4 py-3 font-semibold shadow-lg shadow-indigo-500/25 transition-all disabled:opacity-70 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-[#c7d2fe] focus:ring-offset-2 focus:ring-offset-white hover:translate-y-[-1px] active:translate-y-0.5 btn-auth-primary"
                {% if pending %}disabled{% endif %}
                hx-disabled-elt="this">
            {% if pending %}
                <span class="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-white/60 border-t-transparent"></span>
            {% endif %}
            Wyślij instrukcje resetu
        </button>

        {% set showRegisterLink = showRegisterLink ?? true %}

        <div class="text-sm text-slate-700 text-center space-y-1">
            <p>
                Pamiętasz hasło?
                <a href="/login" data-testid="forgot-link-login" class="text-indigo-600 hover:text-indigo-800 font-semibold underline underline-offset-4 focus-visible:outline focus-visible:outline-2 focus-visible:outline-indigo-300 transition-colors">Zaloguj się</a>
            </p>
            {% if showRegisterLink %}
                <p>
                    Nie masz konta?
                    <a href="/register" class="text-indigo-600 hover:text-indigo-800 font-semibold underline underline-offset-4 transition-colors">Załóż konto</a>
                </p>
            {% endif %}
        </div>
    {% endif %}
</form>


