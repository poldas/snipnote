{% set note = note ?? {} %}
{% set editUrl = note.editUrl ?? '#' %}
{% set publicUrl = note.publicUrl ?? null %}
{% set publicHref = publicUrl ? ((publicUrl|slice(0, 4) == 'http') ? publicUrl : app.request.schemeAndHttpHost ~ publicUrl) : null %}
{% set openHref = publicHref ?? editUrl %}
{% set isShared = note.isShared|default(false) %}
{% set isPublic = note.visibility|lower == 'public' %}
{% set isDraft = note.visibility|lower == 'draft' %}
{% set copyUrl = isPublic? publicHref : app.request.schemeAndHttpHost ~ editUrl %}

<!-- Note Card -->
<div class="group bg-white rounded-2xl border border-slate-200 hover:border-indigo-300 hover:shadow-xl transform hover:scale-[1.02] transition-all duration-300 overflow-hidden">
    <div class="p-4 sm:p-5">
        <div class="flex items-start justify-between mb-3 gap-2">
            <div class="flex items-center gap-1 flex-shrink-0">
                {% if isShared %}
                    <span class="inline-flex items-center gap-1.5 px-2.5 sm:px-3 py-1 bg-sky-50 text-sky-700 rounded-lg text-xs font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
                        </svg>
                        For Me
                    </span>
                {% elseif isPublic %}
                    <span class="inline-flex items-center gap-1.5 px-2.5 sm:px-3 py-1 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Publiczne
                    </span>
                {% elseif isDraft %}
                    <span class="inline-flex items-center gap-1.5 px-2.5 sm:px-3 py-1 bg-orange-50 text-orange-700 rounded-lg text-xs font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Draft
                    </span>
                {% else %}
                    <span class="inline-flex items-center gap-1.5 px-2.5 sm:px-3 py-1 bg-red-50 text-red-700 rounded-lg text-xs font-medium">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        Prywatne
                    </span>
                {% endif %}

                <a href="{{ openHref }}" target="_blank" rel="noopener noreferrer" 
                   data-testid="note-open-link"
                   class="text-indigo-600 hover:text-indigo-700 hover:scale-105 transition-all text-sm font-medium flex items-center gap-1">
                    Otwórz
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
                <button type="button"
                        data-copy-public-link
                        data-testid="note-copy-link-btn"
                        data-link="{{ copyUrl }}"
                        class="text-indigo-600 hover:text-emerald-600 transition-colors text-sm font-medium p-3 rounded-lg hover:bg-emerald-50 min-w-[44px] min-h-[44px] flex items-center justify-center"
                        title="Kopiuj link">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-1 flex-shrink-0">
                <a href="{{ editUrl }}" 
                   class="p-3 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-all min-w-[44px] min-h-[44px] flex items-center justify-center"
                   data-testid="note-edit-btn"
                   title="Edytuj">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </a>
                <button type="button"
                        data-delete-note
                        data-testid="note-delete-btn"
                        data-note-id="{{ note.id }}"
                        data-note-title="{{ note.title|default('(Bez tytułu)') }}"
                        data-delete-url="{{ note.deleteUrl }}"
                        class="p-3 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all min-w-[44px] min-h-[44px] flex items-center justify-center"
                        title="Usuń">
                    <svg class="w-4 h-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
        <h3 class="text-base sm:text-lg font-bold text-slate-900 mb-3 line-clamp-2">{{ note.title is not empty ? note.title : '(Bez tytułu)' }}</h3>
        <p class="text-sm text-slate-600 leading-relaxed mb-4 line-clamp-5">{{ note.excerpt }}</p>
        {% if note.labels is defined and note.labels is not empty %}
            <div class="flex flex-wrap items-center gap-1.5 mb-4">
                {% for label in note.labels %}
                    <span class="px-2.5 py-1 bg-slate-100 text-slate-700 rounded-md text-xs font-medium hover:bg-slate-200 transition-colors cursor-pointer">{{ label }}</span>
                {% endfor %}
            </div>
        {% endif %}
        <div class="pt-3 border-t border-slate-100">
            <div class="flex items-center justify-between text-xs text-slate-500">
                <span>{{ note.createdAt|date('d.m.Y') }}</span>
            </div>
        </div>
    </div>
</div>
